# Лаборатораня работа №1
***
## Задание
Реализовать имитацию рабочего стола используя светодиодную панель P10 и джойстик.

***

## SPI ##
**SPI (Serial Peripheral Interface)** - последовательный синхронный стандарт передачи данных в режиме полного дуплекса, 
предназначенный для обеспечения простого и недорогого высокоскоростного сопряжения микроконтроллеров и периферии

Любая отладочная плата серии STM32 обладает возможностью реализаци подобного способа передачи данных.

**О процессе передачи данных**

Процесс передачи осуществляется последовательно, с формированием пакетов объёмом 1 байт ( 8 бит). Однако, бывают 
случаи, когда его объём уменьшается до 4 бит.

![SPI communication system.png](Additional%20files%2FSPI%20communication%20system.png)

 
Подлежащие передаче данные ведущее и ведомое устройства помещают в сдвиговые регистры. После этого ведущее 
устройство начинает генерировать импульсы синхронизации на линии *SCLK*, что приводит к взаимному обмену данными. 
Передача данных осуществляется бит за битом от ведущего по линии *MOSI* и от ведомого по линии *MISO*. Передача 
осуществляется, как правило, начиная со старших битов, но некоторые производители допускают изменение порядка 
передачи битов программными методами.

***
## P10 ##

Светодиодная панель представляет из себя белую матрицу 32x16 точек с размерами 320x160мм.


![P10.jpg](Additional%20files%2FP10.jpg)![LEDP10_RED.png]

Это основные характеристики данной рабочей матрицы. Дальше рассмотрим **обратную сторону панели***:

![Position of components.jpg](Additional%20files%2FPosition%20of%20components.jpg)

Под цифрами обозначены различные узлы данной системы
1. **1 x SM74HC245D** — неинвертирующий буфер
2. **1 x 88SM74HC04** — 6-канальный инвертор
3. **1 x SM74HC138D** — 8-битный дешифратор
4. **4 x PM4953** — сборка из 2 P-канальных MOSFET
5. **16 x 74HC595D** — сдвиговый регистр с защёлкой

Два 16-пиновых разъёма — интерфейсные, один из них входной (к нему подключается контроллер экрана), а второй — выходной (к нему подключается следующая матрица в цепочке). Стрелка на плате направлена от входного разъёма к выходному.
Питание подаётся на клеммы в центре платы. Напряжение питания — 5В, максимальный ток (когда включены все светодиодны матрицы) — 2А (для белой матрицы).

Ниже приведено принципиальная схема устройства.

![Schematic diagram.gif](Additional%20files%2FSchematic%20diagram.gif)

*******

## Подключение к светодиодной матрице LEDP10 ##

Ниже приведёна распиновка разъема матрицы:

![Pinout contacts.jpg](Additional%20files%2FPinout%20contacts.jpg)

Назначение каждого из пинов
- **A** и **B** - необходим для переключения между строками
- **OE** - отвечает за запуск / отключение матрицы
- **SCK** - канал для синхронизации частот работы переферии
- **MOSI** - канал передачи данных
- **SCLK** - канал подтверждения конца загрузки байта данных.

******************
## Настрйока микроконтроллера и SPI
![PINS_MK.png](Additional%20files%2FPINS_MK.png)

На изображении выше вы можете наблюдать изображение микроконтроллера с 
всеми активными пинами. В данном проекте используется **SPI5** *(могут быть активированы другие, 
однако, мне удолось достичь наиболее оптимальных параметров именно на SPI5 (могу порекомендовать 
применять SPI2 как альтернативу))*.

**Перечень используемых пинов**

- **PD4** - *A* - отвечает за выбор строки для загрузки данных
- **PD5** - *B* - отвечает за выбор строки для загрузки данных
- **PD6** - *OE* - отвечает за включение / выключение панели
- **PD7** - *SCLK* - канал для прменения полученных данных (необходимо 
подать высокий и следом сразу низкий сигнал)
- **PC14** - *RCC_OSC_32_IN* - канал для подключения внешнего тактового резонатора низкой частоты
- **PC15** - *RCC_OSC_32_OUT* - канал для подключения внешнего тактового резонатора низкой частоты
- **PF7** - *SPI5_SCK* - канал для тактирования ведомого устройства от ведущего
- **PF9** - *SPI5_MOSI* -канал для передачи данных
- **PH0** - *RCC_OSC_IN* - канал для подключения внешнего тактового резонатора высокой частоты
- **PH1** - *RCC_OSC_OUT* - канал для подключения внешнего тактового резонатора высокой частоты
- **PA4** - *ADC1_IN4* -канал с АЦП для снятия значения с реостата

![Setings_SPI5.png](Additional%20files%2FSetings_SPI5.png)

Выше вы можете наблюдать параметры настройки SPI5. Вы можете попробовать поменять 
Prescaler с целью улучшения качества изображения или же просто поэкспеременитровать.

В проекте не задействован ни один таймер, так как в нём нет необходимости,
так как в рамках проекта изначально планировалась возможность изменения скорости 
движения, однако, для этого вы можете найти в коде коэффициент **a** и изменить 
соответствующие ему параметры*.

**Орентироваться можете на коментарии внутри кода*
*******************
 ## Последовательность для загрузки данных в матрицу ###

1. Выдаём по SPI данные для сдвиговых регистров. Для одной матрицы 32x16 это 16 байт (16 8-битных регистров).
2. Устанавливаем лог. 0 на ножке nOE.
3. Устанавливаем лог. уровни на ножках A и B в соответствии с обновляемой группой светодиодов (одной из четырёх). Это подаёт +5В на аноды светодиодов выбранной группы.
4. Выдаём на ножку SCLK короткий положительный импульс. Это подаёт землю на катоды светодиодов в соответствии с загруженными в регистры байтами.
5. Устанавливаем лог. 1 на ножке nOE. При этом четверть экрана (одна группа светодиодов) загорается и горит до следующего обновления следующей группы светодиодов.
Повторяем пункты 1-5 с постоянным периодом.

*******************

## Листинги и описание, алгоритмы кода

Вся информация данного типа находится внутри отчёта, расположенного по адресу `/Additional files/Report`.

Описане кода находится внутри файлов `/Drive/Core/Src/main.c` и `Drive/Core/Src/display.c` в коде, вы можете орентироваться внутри кода на коментарии, оставленные к
каждой функции или частям кода, которые могут быть не совсем понятны

*******************
## Практическое подключение матрицы к STM32
Даное подключение актуально только для данного проекта, когда вы будете писать свой проект, то вам понадобиться 
опираться на приведённые выше изображения распиновки матрицы и подключать её к своей STM32 в соответсви с вашими 
пинами, активированными при формировании проекта в CubaMX.

**Пример подключения для STM32**

![STM32_NUCLEA.jpg](Additional%20files%2FSTM32_NUCLEA.jpg)

**Пример подключения для штекера**

![SHTECER.jpg](Additional%20files%2FSHTECER.jpg)

**Пример подключения для штекера, обратная сторона**

![SHTECER_2.jpg](Additional%20files%2FSHTECER_2.jpg)
*******************
 ## Демонстрация работы панели (старая версия) ###
![Work_code.gif](Additional%20files%2FWork_code.gif)


*******************
 ## Демонстрация работы панели (новая версия (актуальная)) ###
![Work_code._now.gif](Additional%20files%2FWork_code._now.gif)

Новая версия наследует все возможности старой, в дополнение имея лишь подвижные облака
